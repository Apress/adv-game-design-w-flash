package{	import flash.events.Event;  import flash.display.*;  import flash.geom.Point;  import flash.geom.Rectangle;  import flash.geom.Matrix;  import flash.utils.getTimer;  import com.friendsofed.utils.*;  import com.friendsofed.vector.*;  import com.friendsofed.gameElements.primitives.*;  import com.friendsofed.gameElements.car.*;  [SWF(width="640", height="512",   backgroundColor="#FFFFFF", frameRate="60")]  	public class AIDrivingGame extends Sprite	{	  private const MAX_TILE_SIZE:uint = 64;	  private const MAP_COLUMNS:uint = 10;	  private const MAP_ROWS:uint = 8;	  	  //Tile ID number codes	  private const ROAD:uint = 30;	  private const GRASS:uint = 31;	  private const CAR:uint = 33;	  private const AI_CAR:uint = 32;	 	  private var _raceTrackMap:Array	    = [	        [31,31,31,31,31,31,31,31,31,31],	        [31,30,30,30,30,30,30,30,30,31],	        [31,30,30,30,30,30,30,30,30,31],	        [31,30,30,31,31,31,31,30,30,31],	        [31,30,30,31,31,31,31,30,30,31],	        [31,30,30,30,30,30,30,30,30,31],	        [31,30,30,30,30,30,30,30,30,31],	        [31,31,31,31,31,31,31,31,31,31]	      ];    	      	  private var _gameObjectMap:Array      = [          [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,32,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,33,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],          [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],        ];        private var _angles:Array      = [          [045,045,045,045,045,045,045,045,045,045],          [315,000,000,000,000,000,000,090,135,135],          [315,000,000,000,000,000,000,090,135,135],          [315,315,270,315,315,315,315,090,090,135],          [315,315,270,135,135,135,135,090,090,135],          [315,315,270,180,180,180,180,180,225,135],          [315,315,315,180,180,180,180,180,225,135],          [225,225,225,225,225,225,225,225,225,225],        ];                	  //Create blank BitmapData objects as the canvas for this game    private var _backgroundBitmapData:BitmapData       = new BitmapData(stage.stageWidth, stage.stageHeight, true, 0);    private var _backgroundBitmap:Bitmap       = new Bitmap(_backgroundBitmapData);  	  	//Tile sheet		[Embed(source="../../images/tileSheet.png")]    private var TileSheet:Class;		private var _tileSheetImage:DisplayObject = new TileSheet();		private var _tileSheetBitmapData:BitmapData 		  = new BitmapData			  (			    _tileSheetImage.width, 			    _tileSheetImage.height, 			    true, 			    0			  );        //Player's car    private var _carTileModel:TileModel;    private var _carController:CarController;    private var _carView:CarView;        //AI car    private var _aiCarTileModel:TileModel;    private var _aiCarView:AICarView;    		//Create a collision Controller		private var _collisionController:TileCollisionController		  = new TileCollisionController();          private var _currentTile:uint = 0;    private var _mapRow:uint = 0;    private var _mapColumn:uint = 0;        //Status box  	private var _statusBox:StatusBox = new StatusBox;				public function AIDrivingGame():void		{  		  //Draw the BitmapData objects			_tileSheetBitmapData.draw(_tileSheetImage);					  //Add the background bitmap, which is the		  //race track map			addChild(_backgroundBitmap);						//Add the status box			addChild(_statusBox);						//Run the buildMap method to convert the			//map array data into a visual display			buildMap(_raceTrackMap);			buildMap(_gameObjectMap);				addEventListener(Event.ENTER_FRAME, enterFrameHandler);		}		private function enterFrameHandler(event:Event):void		{ 		  //Update the car's Model		  _carTileModel.update();		  		  //Update the AI car		  _aiCarTileModel.update();		  		  //Stop the car at the stage boundaries		  StageBoundaries.stopBitmap(_carTileModel, stage); 		  		  if(_raceTrackMap[_carTileModel.mapRow][_carTileModel.mapColumn]			  == GRASS)			{			  _carTileModel.friction = 0.85;		  }		  else		  {		    _carTileModel.friction = 0.98;		  }		  		  if(_raceTrackMap		    [_aiCarTileModel.mapRow][_aiCarTileModel.mapColumn]			  == GRASS)			{			  _aiCarTileModel.friction = 0.85;		  }		  else		  {		    _aiCarTileModel.friction = 0.98;		  }		  		  var currentAngle:Number = _aiCarTileModel.rotationValue;		  var targetAngle:Number 		    = _angles[_aiCarTileModel.mapRow][_aiCarTileModel.mapColumn]		  var difference:Number = currentAngle - targetAngle;    	    	if(difference > 0    	&& difference < 180)			{			  //Turn left			   _aiCarTileModel.rotationSpeed = -2; 		  }		  else		  {		    //Turn right		    _aiCarTileModel.rotationSpeed = 2; 		    		    //Note: randomize the rotation speed for		    //unpredictable and organic driving effect		  }		  		  //Update status box			_statusBox.text = "DRIVING GAME:"; 			_statusBox.text 			  += "\n" + "CURRENT AI CAR'S TILE: " 			  + _raceTrackMap[_carTileModel.mapRow][_carTileModel.mapColumn]			  + ": " 			  + _carTileModel.mapRow 			  + _carTileModel.mapColumn;  			if(_raceTrackMap			  [_aiCarTileModel.mapRow][_aiCarTileModel.mapColumn]			  == ROAD)			{		    _statusBox.text += "\n" + "AI CAR ON: Road"; 		  }		  else		  {		    _statusBox.text += "\n" + "AI CAR ON: Grass"; 		  }		  _statusBox.text 			  += "\n" + "AI CAR'S ANGLE: "  + _aiCarTileModel.rotationValue;			   		 }				//Create tile Models and map them to the		//correct positions on the tile sheet		private function buildMap(map:Array):void	  {      for(var mapColumn:int = 0; mapColumn < MAP_COLUMNS; mapColumn++)      {        for(var mapRow:int = 0; mapRow < MAP_ROWS; mapRow++)        {          var currentTile:int = map[mapRow][mapColumn];                  if(currentTile > -1)          {            //Find the tile's column and row position            //on the tile sheet            var tileSheetColumn:uint               = uint(currentTile / 10);            var tileSheetRow:uint               = uint(currentTile % 10);                        switch(currentTile)            {              case CAR:                _carTileModel  	              = new CarTileModel      	          (      	            MAX_TILE_SIZE,      	            tileSheetColumn, tileSheetRow,       	            mapRow, mapColumn,       	            48, 48      	          );   	              	        //Add the View and Controller        	        _carController      	          = new CarController(_carTileModel);    	          _carView    		          = new CarView    		          (_carTileModel, _carController, stage);    		            	            //Load the tile from the tile sheet into the  	            //car's containing Sprite      	        loadTileIntoView      	          (_carTileModel, _carView.carBitmapData);      	                	        //Add the car's View to the stage        	        stage.addChild(_carView);      	        break;      	                      case AI_CAR:                _aiCarTileModel  	              = new CarTileModel      	          (      	            MAX_TILE_SIZE,      	            tileSheetColumn, tileSheetRow,       	            mapRow, mapColumn,       	            48, 48      	          );     	          _aiCarView    		          = new AICarView    		          (_aiCarTileModel, stage);  	              	        loadTileIntoView      	          (_aiCarTileModel, _aiCarView.carBitmapData);      	        stage.addChild(_aiCarView);      	              	        //Start the car moving by setting its      	        //accelerate property to true		            CarTileModel(_aiCarTileModel).accelerate = true;		                            break;                              case ROAD:                var road:TileModel                   = new TileModel                  (                    MAX_TILE_SIZE,                    tileSheetColumn, tileSheetRow,       	            mapRow, mapColumn,       	            MAX_TILE_SIZE, MAX_TILE_SIZE                  );                drawGameObject(road, _backgroundBitmapData);                          case GRASS:                var grass:TileModel                   = new TileModel                  (                    MAX_TILE_SIZE,                    tileSheetColumn, tileSheetRow,       	            mapRow, mapColumn,       	            MAX_TILE_SIZE, MAX_TILE_SIZE                  );      	        drawGameObject(grass, _backgroundBitmapData);           }         }       }     }   }				private function drawGameObject		  (		    tileModel:TileModel, 		    screen:BitmapData		  ):void		{		  var sourceRectangle:Rectangle = new Rectangle  			(  		    tileModel.tileSheetColumn * MAX_TILE_SIZE,   			  tileModel.tileSheetRow * MAX_TILE_SIZE,   			  tileModel.width,   			  tileModel.height  			);					  	  var destinationPoint:Point = new Point      (        tileModel.xPos,         tileModel.yPos      );            screen.copyPixels        (          _tileSheetBitmapData,           sourceRectangle,           destinationPoint,          null, null, true        );	  }	  private function loadTileIntoView	    (tileModel:TileModel, bitmapData:BitmapData):void		{		  var sourceRectangle:Rectangle = new Rectangle  			(  		    tileModel.tileSheetColumn * MAX_TILE_SIZE,   			  tileModel.tileSheetRow * MAX_TILE_SIZE,   			  tileModel.width,   			  tileModel.height  			);					  	  var destinationPoint:Point = new Point(0, 0);            bitmapData.copyPixels        (          _tileSheetBitmapData,           sourceRectangle,           destinationPoint,          null, null, true        );	  }	}}